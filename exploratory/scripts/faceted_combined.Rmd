---
title: "faceted_combined"
author: "Jonah Bukovac"
date: "2025-06-23"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readxl)
View(completedtrialdesign)
```

```{r}

library(tidyverse)


completedtrialdesign <- completedtrialdesign %>%
  mutate(YearGroup = case_when(
    Initiation <= 2005 ~ "≤2005",
    Initiation >= 2006 & Initiation <= 2010 ~ "2006–2010",
    Initiation >= 2011 & Initiation <= 2015 ~ "2011–2015",
    Initiation >= 2016 & Initiation <= 2020 ~ "2016–2020",
    TRUE ~ "Unknown"
  ))


completedtrialdesign$YearGroup <- factor(
  completedtrialdesign$YearGroup,
  levels = c("≤2005", "2006–2010", "2011–2015", "2016–2020", "Unknown")
)



design_levels <- rev(c(
  "RCT", 
  "Parallel Assignment", 
  "Single Group Assignment", 
  "Parallel Assignment (randomized)", 
  "Single Group Crossover", 
  "Crossover Assignment"
))


other_designs <- setdiff(unique(completedtrialdesign$Design), design_levels)


full_design_levels <- c(design_levels, sort(other_designs))


completedtrialdesign$Design <- factor(completedtrialdesign$Design, levels = full_design_levels)



trial_counts <- completedtrialdesign %>%
  count(YearGroup, Design)


ggplot(trial_counts, aes(x = YearGroup, y = n, fill = Design)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Trial Design Over Time",
    x = "Year Group",
    y = "Number of Trials",
    fill = "Trial Design"
  ) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )


```



```{r}
otw_data[21, 7] <- "None"
```


```{r}
library(tidyverse)

# STEP 1: Define YearGroup using Trial Initiation
otw_data <- otw_data %>%
  mutate(YearGroup = case_when(
    `Trial Initiation` <= 2005 ~ "≤2005",
    `Trial Initiation` >= 2006 & `Trial Initiation` <= 2010 ~ "2006–2010",
    `Trial Initiation` >= 2011 & `Trial Initiation` <= 2015 ~ "2011–2015",
    `Trial Initiation` >= 2016 & `Trial Initiation` <= 2020 ~ "2016–2020",
    `Trial Initiation` >= 2021 & `Trial Initiation` <= 2025 ~ "2021–2025",
    TRUE ~ "Unknown"
  ),
  YearGroup = factor(YearGroup, levels = c("≤2005", "2006–2010", "2011–2015", "2016–2020", "2021–2025", "Unknown"))
  )


# STEP 2: Set consistent design levels
design_levels <- rev(c(
  "RCT", 
  "Parallel Assignment", 
  "Single Group Assignment", 
  "Sequential Assignment (non-randomized)", 
  "Single Group Crossover", 
  "Crossover Assignment"
))

other_designs <- setdiff(unique(otw_data$Design), design_levels)
full_design_levels <- c(design_levels, sort(other_designs))

otw_data$Design <- factor(otw_data$Design, levels = full_design_levels)

# STEP 3: Filter datasets by status
inprogress_data <- otw_data %>% filter(Status == "In-progress")
terminated_data <- otw_data %>% filter(Status %in% c("Terminated", "Withdrawn"))

# STEP 4: Count trials by YearGroup and Design
inprogress_counts <- inprogress_data %>%
  count(YearGroup, Design)

terminated_counts <- terminated_data %>%
  count(YearGroup, Design)

# STEP 5: Plot - In-progress trials
plot_inprogress <- ggplot(inprogress_counts, aes(x = YearGroup, y = n, fill = Design)) +
  geom_bar(stat = "identity") +
  labs(
    title = "In-progress Trials by Year and Design",
    x = "Trial Initiation Year Group",
    y = "Number of Trials",
    fill = "Design"
  ) +
  theme_minimal() +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# STEP 6: Plot - Terminated/Withdrawn trials
plot_terminated <- ggplot(terminated_counts, aes(x = YearGroup, y = n, fill = Design)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Terminated or Withdrawn Trials by Year and Design",
    x = "Trial Initiation Year Group",
    y = "Number of Trials",
    fill = "Design"
  ) +
  theme_minimal() +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(
    legend.position = "bottom",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# STEP 7: Print the plots
print(plot_inprogress)
print(plot_terminated)

```
```{r}
library(tidyverse)

### === 1. Prepare completedtrialdesign ===

completedtrialdesign <- completedtrialdesign %>%
  mutate(YearGroup = case_when(
    Initiation <= 2005 ~ "≤2005",
    Initiation >= 2006 & Initiation <= 2010 ~ "2006–2010",
    Initiation >= 2011 & Initiation <= 2015 ~ "2011–2015",
    Initiation >= 2016 & Initiation <= 2020 ~ "2016–2020",
    TRUE ~ "Unknown"
  ),
  YearGroup = factor(YearGroup, levels = c("≤2005", "2006–2010", "2011–2015", "2016–2020", "Unknown"))
)

# Standardize design levels
# Standardize design levels
design_levels <- rev(c(
  "RCT", 
  "Parallel Assignment", 
  "Single Group Assignment", 
  "Parallel Assignment (randomized)", 
  "Single Group Crossover", 
  "Sequential Assignment (non-randomized)",
  "Crossover Assignment"
))


other_designs <- setdiff(unique(completedtrialdesign$Design), design_levels)
full_design_levels <- c(design_levels, sort(other_designs))

completedtrialdesign$Design <- factor(completedtrialdesign$Design, levels = full_design_levels)

# Count trials
completed_counts <- completedtrialdesign %>%
  count(YearGroup, Design) %>%
  mutate(Dataset = "Completed")


### === 2. Prepare otw_data ===

# Add YearGroup to otw_data
otw_data <- otw_data %>%
  mutate(YearGroup = case_when(
    `Trial Initiation` <= 2005 ~ "≤2005",
    `Trial Initiation` >= 2006 & `Trial Initiation` <= 2010 ~ "2006–2010",
    `Trial Initiation` >= 2011 & `Trial Initiation` <= 2015 ~ "2011–2015",
    `Trial Initiation` >= 2016 & `Trial Initiation` <= 2020 ~ "2016–2020",
    `Trial Initiation` >= 2021 & `Trial Initiation` <= 2025 ~ "2021–2025",
    TRUE ~ "Unknown"
  ),
  YearGroup = factor(YearGroup, levels = c("≤2005", "2006–2010", "2011–2015", "2016–2020", "2021–2025", "Unknown")),
  Design = factor(Design, levels = full_design_levels)
)

# In-progress data
inprogress_counts <- otw_data %>%
  filter(Status == "In-progress") %>%
  count(YearGroup, Design) %>%
  mutate(Dataset = "In-progress")

# Terminated/Withdrawn data
terminated_counts <- otw_data %>%
  filter(Status %in% c("Terminated", "Withdrawn")) %>%
  count(YearGroup, Design) %>%
  mutate(Dataset = "Terminated/Withdrawn")

### === 3. Combine all three datasets ===

combined_counts <- bind_rows(
  completed_counts,
  inprogress_counts,
  terminated_counts
)

### === 4. Plot faceted bar plot ===

library(ggplot2)
library(viridis)

final_plot2 <- ggplot(combined_trials, aes(x = TimeGroup, y = n, fill = AdjuvantSimplified)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ StatusGroup, nrow = 1) +
  labs(
    title = "Number of Clinical Trials by Year and Concurrent Treatment/Study Design",
    x = "Year",
    y = "Number of Trials",
    fill = "Concurrent Treatment"
  ) +
  scale_fill_viridis_d(option = "mako") +  # Deep blue/cyan
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1)
  )

# Display and save
print(final_plot2)


```
```

```{r}
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Facet Plot for Completed, In-Progress, and Terminated Trials
```{r}
library(readxl)
View(otw_data)
```

```{r}
otw_data[21, 7] <- "None"
```

```{r}
library(tidyverse)

otw_data <- otw_data %>%
  mutate(
    AdjuvantSimplified = case_when(
      str_detect(`Adjuvant Therapy`, regex("Immunotherapy", ignore_case = TRUE)) ~ "Immunotherapy",
      str_detect(`Adjuvant Therapy`, regex("Chemoradiation", ignore_case = TRUE)) ~ "Chemoradiation",
      str_detect(`Adjuvant Therapy`, regex("Chemotherapy", ignore_case = TRUE)) ~ "Chemotherapy",
      str_detect(`Adjuvant Therapy`, regex("None", ignore_case = TRUE)) ~ "None",
      TRUE ~ "Other"
    )
  )


otw_data <- otw_data %>%
  mutate(
    TimeGroup = case_when(
      `Trial Initiation` <= 2010 ~ "≤2010",
      `Trial Initiation` >= 2011 & `Trial Initiation` <= 2015 ~ "2011–2015",
      `Trial Initiation` >= 2016 & `Trial Initiation` <= 2020 ~ "2016–2020",
      `Trial Initiation` >= 2021 ~ "2021–2025",
      TRUE ~ "Unknown"
    ),
    TimeGroup = factor(TimeGroup, levels = c("≤2010", "2011–2015", "2016–2020", "2021–2025"))
  )


otw_data$AdjuvantSimplified <- factor(
  otw_data$AdjuvantSimplified,
  levels = c("None", "Other", "Chemotherapy", "Chemoradiation", "Immunotherapy")
)


plot_data <- otw_data %>%
  count(TimeGroup, AdjuvantSimplified)


ggplot(plot_data, aes(x = TimeGroup, y = n, fill = AdjuvantSimplified)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Number of Clinical Trials by Year Group and Treatment Type",
    x = "Trial Initiation Period",
    y = "Number of Trials",
    fill = "Treatment"
  ) +
  theme_minimal() +
   scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme(
    legend.position = "right",         
    axis.text.x = element_text(angle = 0, hjust = 0.5)  
  )

```




```{r}
library(readxl)
View(treatmentinitiation_data)
```


```{r}
treatmentinitiation_data$Initiation <- as.numeric(treatmentinitiation_data$Initiation)
```

```{r}
treatmentinitiation_data <- treatmentinitiation_data %>%
  mutate(Treatment = case_when(
    Treatment %in% c("Bevacizumab", "Chemotherapy or Radiation Therapy") ~ "Other",
    TRUE ~ Treatment
  ))

```

```{r}
treatmentinitiation_data <- treatmentinitiation_data %>%
  mutate(YearGroup = case_when(
    Initiation <= 2005 ~ "≤2005",
    Initiation >= 2006 & Initiation <= 2010 ~ "2006–2010",
    Initiation >= 2011 & Initiation <= 2015 ~ "2011–2015",
    Initiation >= 2016 & Initiation <= 2020 ~ "2016–2020",
    TRUE ~ "Other"
  ))
```

```{r}
treatmentinitiation_data$YearGroup <- factor(treatmentinitiation_data$YearGroup, levels = c("≤2005", "2006–2010", "2011–2015", "2016–2020", "Other"))
```

```{r}
treatmentinitiation_summary <- treatmentinitiation_data %>%
  count(YearGroup, Treatment)
```

```{r}
treatmentinitiation_summary$Treatment <- factor(treatmentinitiation_summary$Treatment, levels = c("Chemotherapy", "Chemoradiation", "Radiotherapy", "Other", "None"))
```

```{r}
ggplot(treatmentinitiation_summary, aes(x = YearGroup, y = n, fill = Treatment)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Number of Clinical Trials by Year Group and Treatment Type",
    x = "Year Group",
    y = "Number of Trials",
    fill = "Treatment"
  ) +
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_minimal(base_size = 14)








```



```{r}
# Load libraries
library(tidyverse)

# Step 1: Simplify Adjuvant Therapy into main categories
otw_data <- otw_data %>%
  mutate(
    AdjuvantSimplified = case_when(
      str_detect(`Adjuvant Therapy`, regex("Immunotherapy", ignore_case = TRUE)) ~ "Immunotherapy",
      str_detect(`Adjuvant Therapy`, regex("Chemoradiation", ignore_case = TRUE)) ~ "Chemoradiation",
      str_detect(`Adjuvant Therapy`, regex("Chemotherapy", ignore_case = TRUE)) ~ "Chemotherapy",
      str_detect(`Adjuvant Therapy`, regex("None", ignore_case = TRUE)) ~ "None",
      TRUE ~ "Other"
    ),
    TimeGroup = case_when(
      `Trial Initiation` <= 2010 ~ "≤2010",
      `Trial Initiation` >= 2011 & `Trial Initiation` <= 2015 ~ "2011–2015",
      `Trial Initiation` >= 2016 & `Trial Initiation` <= 2020 ~ "2016–2020",
      `Trial Initiation` >= 2021 ~ "2021–2025",
      TRUE ~ "Unknown"
    ),
    TimeGroup = factor(TimeGroup, levels = c("≤2010", "2011–2015", "2016–2020", "2021–2025")),
    AdjuvantSimplified = factor(
      AdjuvantSimplified,
      levels = c("Immunotherapy", "Chemoradiation", "Chemotherapy", "Other", "None")
    )
  )

# Step 2a: Filter and count In-progress trials
in_progress_data <- otw_data %>%
  filter(Status == "In-progress") %>%
  count(TimeGroup, AdjuvantSimplified)

# Step 2b: Filter and count Terminated and Withdrawn trials
inactive_data <- otw_data %>%
  filter(Status %in% c("Terminated", "Withdrawn")) %>%
  count(TimeGroup, AdjuvantSimplified)

# Step 3a: Plot In-progress
ggplot(in_progress_data, aes(x = TimeGroup, y = n, fill = AdjuvantSimplified)) +
  geom_bar(stat = "identity") +
  labs(
    title = "In-Progress Clinical Trials by Year Group and Treatment Type",
    x = "Trial Initiation Period",
    y = "Number of Trials",
    fill = "Treatment"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

# Step 3b: Plot Terminated/Withdrawn
ggplot(inactive_data, aes(x = TimeGroup, y = n, fill = AdjuvantSimplified)) +
  geom_bar(stat = "identity") +
  labs(
    title = "Terminated or Withdrawn Clinical Trials by Year Group and Treatment Type",
    x = "Trial Initiation Period",
    y = "Number of Trials",
    fill = "Treatment"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

```

```{r}
# Step 4: Add a group label and combine
in_progress_data$StatusGroup <- "In-progress"
inactive_data$StatusGroup <- "Terminated or Withdrawn"

combined_plot_data <- bind_rows(in_progress_data, inactive_data)

# Step 5: Faceted stacked bar chart
ggplot(combined_plot_data, aes(x = TimeGroup, y = n, fill = AdjuvantSimplified)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ StatusGroup) +
  labs(
    title = "Number of Clinical Trials by Year Group and Treatment Type",
    x = "Trial Initiation Period",
    y = "Number of Trials",
    fill = "Treatment"
  ) +
  theme_minimal() +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 0, hjust = 0.5)
  )

```


```{r}
# Load libraries
library(tidyverse)
library(readxl)

# -------------------------
# 1. Prepare otw_data trials (In-progress, Terminated/Withdrawn)
# -------------------------

otw_data <- otw_data %>%
  mutate(
    AdjuvantSimplified = case_when(
      str_detect(`Adjuvant Therapy`, regex("Immunotherapy", ignore_case = TRUE)) ~ "Immunotherapy",
      str_detect(`Adjuvant Therapy`, regex("Chemoradiation", ignore_case = TRUE)) ~ "Chemoradiation",
      str_detect(`Adjuvant Therapy`, regex("Chemotherapy", ignore_case = TRUE)) ~ "Chemotherapy",
      str_detect(`Adjuvant Therapy`, regex("None", ignore_case = TRUE)) ~ "None",
      TRUE ~ "Other"
    ),
    TimeGroup = case_when(
      `Trial Initiation` <= 2005 ~ "≤2005",
      `Trial Initiation` >= 2006 & `Trial Initiation` <= 2010 ~ "2006–2010",
      `Trial Initiation` >= 2011 & `Trial Initiation` <= 2015 ~ "2011–2015",
      `Trial Initiation` >= 2016 & `Trial Initiation` <= 2020 ~ "2016–2020",
      `Trial Initiation` >= 2021 ~ "2021–2025",
      TRUE ~ "Other"
    ),
    TimeGroup = factor(TimeGroup, levels = c("≤2005", "2006–2010", "2011–2015", "2016–2020", "2021–2025"))
  )

# Count in-progress
in_progress_data <- otw_data %>%
  filter(Status == "In-progress") %>%
  count(TimeGroup, AdjuvantSimplified) %>%
  mutate(StatusGroup = "In-progress")

# Count terminated or withdrawn
inactive_data <- otw_data %>%
  filter(Status %in% c("Terminated", "Withdrawn")) %>%
  count(TimeGroup, AdjuvantSimplified) %>%
  mutate(StatusGroup = "Terminated/Withdrawn")

# -------------------------
# 2. Prepare completed trials (treatmentinitiation_data)
# -------------------------

# Convert year and simplify treatment
treatmentinitiation_data$Initiation <- as.numeric(treatmentinitiation_data$Initiation)

treatmentinitiation_data <- treatmentinitiation_data %>%
  mutate(
    Treatment = case_when(
      Treatment %in% c("Bevacizumab", "Chemotherapy or Radiation Therapy") ~ "Other",
      TRUE ~ Treatment
    ),
    TimeGroup = case_when(
      Initiation <= 2005 ~ "≤2005",
      Initiation >= 2006 & Initiation <= 2010 ~ "2006–2010",
      Initiation >= 2011 & Initiation <= 2015 ~ "2011–2015",
      Initiation >= 2016 & Initiation <= 2020 ~ "2016–2020",
      Initiation >= 2021 ~ "2021–2025",
      TRUE ~ "Other"
    ),
    TimeGroup = factor(TimeGroup, levels = c("≤2005", "2006–2010", "2011–2015", "2016–2020", "2021–2025"))
  )

# Count completed trials
completed_data <- treatmentinitiation_data %>%
  count(TimeGroup, Treatment) %>%
  rename(AdjuvantSimplified = Treatment) %>%
  mutate(StatusGroup = "Completed")

# -------------------------
# 3. Combine all data
# -------------------------

combined_trials <- bind_rows(in_progress_data, inactive_data, completed_data)

combined_trials$AdjuvantSimplified <- factor(combined_trials$AdjuvantSimplified,
  levels = c("Immunotherapy", "Chemoradiation", "Chemotherapy", "Radiotherapy", "Other", "None")
)

# -------------------------
# 4. Plot and save
# -------------------------

library(ggplot2)
library(viridis)

final_plot <- ggplot(combined_counts, aes(x = YearGroup, y = n, fill = Design)) +
  geom_bar(stat = "identity") +
  facet_wrap(~ Dataset, nrow = 1) +
  labs(
    x = "Year",
    y = "Number of Trials",
    fill = "Design"
  ) +
  scale_fill_viridis_d(option = "plasma") +  # Vibrant purples/yellows
  scale_y_continuous(breaks = scales::pretty_breaks(n = 10)) +
  theme_bw(base_size = 14) +
  theme(
    legend.position = "right",
    axis.text.x = element_text(angle = 45, hjust = 1),
    strip.text = element_text(face = "plain")
  )

# Display and save
print(final_plot)



```

```{r}
library(patchwork)

combined <- final_plot / final_plot2 + plot_layout(ncol = 1)

print(combined)
ggsave("faceted_combined.png", combined, width = 12, height = 12, dpi = 300)

```


```{r}
# 1. install & load
if (!requireNamespace("magick",  quietly=TRUE)) install.packages("magick")
library(magick)

# 2. define inputs
pdf_path    <- path.expand("~/keto-rev/exploratory/data/figures/faceted_combined_pptx.pdf")
png_path    <- path.expand("~/keto-rev/exploratory/data/figures/faceted_combined_pptx.png")

# 3. set your target size & resolution
dpi         <- 900                # dots-per-inch for print-quality
width_in    <-  6.5               # inches
height_in   <-  5                 # inches
width_px    <- width_in  * dpi    # 1950 px
height_px   <- height_in * dpi    # 1500 px

# 4. read the PDF at high density
img <- image_read_pdf(pdf_path, density = dpi)

# (If your PDF has multiple pages and you only want page 1:)
# img <- image_read_pdf(pdf_path, density = dpi, pages = 1)

# 5. resize to exact dimensions (the “!” forces exact pixel size)
img <- image_resize(img, geometry = paste0(width_px, "x", height_px, "!"))

# 6. (Optional) Trim extra whitespace
img <- image_trim(img)

# 7. write out your PNG
image_write(img, path = png_path, format = "png")
```




